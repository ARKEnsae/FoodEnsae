---
title: "Nutri-score par marque"
weight: 4
---

Explorons les principales **marques** et les **nutri-scores** de leurs produits.

```{r, include=FALSE}
library(highcharter)
library(widgetframe)
library(dplyr)
colors_grade <- readRDS("data/colors.RDS")[1:5]
my_own_theme <- readRDS("data/hc_theme.RDS")

brand_grade_t15 <- readRDS("data/top15_brands.RDS")
```


```{r treemapBrand, echo=FALSE}
titre <- "Répartition des Nutri-Scores par marque"
caption_txt <- "On se restreint aux 10 principales marques en terme de nombre de produits vendus en France recensés dans la base d'OpenFoodFactspour lesquels le Nutri-Score est disponible."
max_prop <- sapply(unique(brand_grade_t15$id),function(b){
  brand_grade_t15 %>% filter(id == b) %>% 
    arrange(-n) %>% .[1,"nutriscore_grade"] %>% as.character()
})
max_prop <- sapply(unique(brand_grade_t15$id),function(b){
  brand_grade_t15 %>% filter(id == b) %>% 
    arrange(-n) %>% .[1,"nutriscore_grade"] %>% as.character()
})
data_plot <- data_to_hierarchical(brand_grade_t15, c(brands,nutriscore_grade),c(n))
data_plot2 <- lapply(data_plot,function(x){
  if(x$level==1){
    x$pct = ""
    return(x)
  }else{
    x$color = as.character(colors_grade[x$name])
    x$pct = brand_grade_t15 %>% 
      filter(id == x$parent, nutriscore_grade == x$name) %>% select(prop) %>% 
      as.numeric %>% 
      formatC(decimal.mark = ",",
              digits = 1, format = "f") %>% 
      sprintf(" (%s %%)",.)
    if(x$name == max_prop[x$parent]){
      x$borderWidth=3
      x$dataLabels$enabled = TRUE
    }
    return(x)
  }
})
lvl_opts <-  list(
  list(
    level = 1,
    borderWidth = 5,
    borderColor = "black",
    dataLabels = list(
      enabled = TRUE,
      align = "left",
      verticalAlign = "top",
      style = list(fontSize = "12px", textOutline = FALSE, color = "white")
    )
  ),
  list(
    level = 2,
    # borderWidth = 0,
    borderColor = "gray",
    # colorVariation = list(key = "brightness", to = 0.250),
    dataLabels = list(enabled = FALSE), # pour ne pas afficher legend sur graph
    style = list(fontSize = "8px", textOutline = FALSE, color = "white")
  )
)
hchart(
  data_plot2,
  type = "treemap",
  # levelIsConstant = FALSE,
  # allowDrillToNode = TRUE,
  levels = lvl_opts,
  tooltip = list(valueDecimals = FALSE),
  showInLegend = FALSE,
  legendType= 'point'
)  %>% 
  hc_title(
    text = titre
  ) %>% hc_caption(
    text = caption_txt
  ) %>%
  hc_add_theme(my_own_theme) %>% 
  hc_tooltip(pointFormat = "<b>{point.name}</b> : {point.value}{point.pct}<br/>") %>% 
  frameWidget(elementId = "treemapBrand")
```


